using Harmonix.Shared.Models;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace Harmonix.Shared.Data.DbConfig;

public class RefreshTokenDbConfig : IEntityTypeConfiguration<RefreshToken>
{
    public void Configure(EntityTypeBuilder<RefreshToken> builder)
    {
        builder.ToTable("refresh_tokens");

        builder.HasKey(rt => rt.Id);

        builder.Property(rt => rt.Id).HasColumnName("id").HasColumnType("uniqueidentifier");
        builder.Property(rt => rt.UserId).HasColumnName("user_id").HasColumnType("uniqueidentifier");
        builder.Property(rt => rt.Token).HasColumnName("token").IsRequired().HasMaxLength(256);
        builder.Property(rt => rt.ExpiresAt).HasColumnName("expires_at").HasColumnType("datetime2").IsRequired();
        builder.Property(rt => rt.RevokedAt).HasColumnName("revoked_at").HasColumnType("datetime2").IsRequired(false);
        builder.Property(rt => rt.CreatedAt).HasColumnName("created_at").HasColumnType("datetimeoffset").IsRequired();

        builder.HasIndex(rt => rt.Token).IsUnique().HasDatabaseName("ux_refresh_tokens_token");
        builder.HasIndex(rt => rt.UserId).HasDatabaseName("ix_refresh_tokens_user_id");
        builder.HasIndex(rt => rt.ExpiresAt).HasDatabaseName("ix_refresh_tokens_expires_at");

        builder.HasOne(rt => rt.User)
            .WithMany(u => u.RefreshTokens)
            .HasForeignKey(rt => rt.UserId)
            .OnDelete(DeleteBehavior.Cascade);

        builder.HasQueryFilter(rt => !rt.Removed);
    }
}
